# Modules:
# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html
# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html
# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/unarchive_module.html
# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html
# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html
# https://docs.ansible.com/ansible/latest/collections/community/general/modprobe_module.html
# https://docs.ansible.com/ansible/latest/collections/ansible/posix/sysctl_module.html
---
- name: CNI | Create directories
  become: true
  ansible.builtin.file:
    dest: "{{item}}"
    owner: root
    group: root
    mode: '0755'
    state: directory
  loop:
  - "{{cni_merged['bin_folder']}}"
  - "{{cni_merged['template_folder']}}"

- name: CNI | Download archive
  become: true
  ansible.builtin.get_url:
    url: "http://github.com/containernetworking/plugins/releases/download/v{{item['version']}}/cni-plugins-linux-amd64-v{{item['version']}}.tgz"
    dest: "/tmp/cni-plugins-linux-amd64-v{{item['version']}}.tgz"
    checksum: "sha1:https://github.com/containernetworking/plugins/releases/download/v{{item['version']}}/cni-plugins-linux-amd64-v{{item['version']}}.tgz.sha1"
    mode: '0644'
    timeout: 300
  loop:
  - "{{cni_merged}}"
  loop_control:
    label: "Download CNI archive (v{{item['version']}})"
  register: result
  until: result is succeeded

- name: CNI | Unarchive
  ansible.builtin.unarchive:
    src: /tmp/cni-plugins-linux-amd64-v{{item['version']}}.tgz
    dest: "{{item['bin_folder']}}"
    mode: '0755'
    remote_src: true
  loop:
  - "{{cni_merged}}"
  loop_control:
    label: "Unarchive CNI binaries to {{item['bin_folder']}}"

- name: CNI | Copy templates
  become: true
  ansible.builtin.template:
    dest: "{{item['dest']}}"
    src: "{{item['src']}}"
    owner: root
    group: root
    mode: '0644'
  loop:
  - src: 99-loopback.conf.j2
    dest: /etc/cni/net.d/99-loopback.conf

- name: === BRIDGE ROUTING (SYSTEMD) ===
  block:
  - name: CNI | Enable bridge kernel module(s)
    become: true
    community.general.modprobe:
      name: "{{item}}"
      state: present
    loop:
    - br_netfilter
    ignore_errors: true

  - name: CNI | Create CNI-bridge tunables
    become: true
    ansible.builtin.lineinfile:
      path: "/proc/sys/net/bridge/bridge-nf-call-{{item}}"
      create: true
      line: '1'
      state: present
    loop:
    - arptables
    - ip6tables
    - iptables
    ignore_errors: true

  - name: CNI | Set CNI-bridge tunables
    become: true
    ignore_errors: true
    ansible.posix.sysctl:
      name: "{{item}}"
      value: '1'
      sysctl_set: true
      state: present
      reload: true
    loop:
    - net.bridge.bridge-nf-call-arptables
    - net.bridge.bridge-nf-call-iptables
    - net.bridge.bridge-nf-call-ip6tables
  when: (ansible_service_mgr == 'systemd') and
        cni_merged['bridge_routing']

- name: === BRIDGE ROUTING (UNSUPPORTED) ===
  block:
  - name: CNI | Bridge routing info
    debug:
      msg: "Init {{ansible_service_mgr}} is unsupported"
  when: (ansible_service_mgr != 'systemd') and
        cni_merged['bridge_routing']

...
